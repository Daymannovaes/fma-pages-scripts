/**
Autogenerated
by dayamnnovaes
at Wed Jun 19 2024 18:24:03 GMT-0300 (Brasilia Standard Time)

This script creates an object `fmalib` in the global scope (window), which a method `handleCurrentPageRedirect`
that can be called to handle the redirect to the checkout page.

Ensure you're calling `fmalib.handleCurrentPageRedirect()` on the page where you want to handle the redirect.
*/
(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :
  typeof define === 'function' && define.amd ? define(['exports'], factory) :
  (global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.fmalib = {}));
})(this, (function (exports) { 'use strict';

  function handleCurrentPageRedirect() {
    const params = getQueryParamsFromCurrentPage();

    if (Object.keys(params).length === 0) {
      return console.log('fma-redirect handleCurrentPageRedirect empty');
    }

    if (shouldRedirectToCheckout()) {
        redirectToCheckout();
    } else {
      mergeParamsInLocalStorage(params);
    }
  }

  function getQueryParamsFromCurrentPage() {
    return getQueryParamsFromUrl(window.location.search);
  }

  function getQueryParamsFromUrl(url) {
    const params = new URLSearchParams(url);
    const queryParams = {};
    params.forEach((value, key) => {
        queryParams[key] = value;
    });
    return queryParams;
  }

  function shouldRedirectToCheckout() {
    const params = getQueryParamsFromCurrentPage();
    return params.step === 'checkout_redirect' && params.checkout_url;
  }

  function redirectToCheckout() {
    const { checkout_url } = getQueryParamsFromCurrentPage();
    const checkoutUrl = new URL(decodeURIComponent(checkout_url));

    const savedParams = getParamsFromLocalStorage();

    const finalUrl = appendQueryParamsToUrl(checkoutUrl, savedParams);

    window.location.href = finalUrl;
  }

  function appendQueryParamsToUrl(url, params) {
    const urlObj = new URL(url);
    for (const key in params) {
        urlObj.searchParams.set(key, params[key]);
    }
    return urlObj.toString();
  }

  function mergeParamsInLocalStorage(queryParams) {
    const storedParams = getParamsFromLocalStorage();
    const mergedParams = { ...storedParams, ...queryParams };

    saveParamsInLocalStorage(mergedParams);

  }

  function getParamsFromLocalStorage() {
    try {
      const storedParams = localStorage.getItem('fma_params');
      return storedParams ? JSON.parse(storedParams) : {};
    } catch (error) {
      console.error('fma-redirect getParamsFromLocalStorage error', error);
      return {};
    }
  }

  function saveParamsInLocalStorage(queryParams) {
    localStorage.setItem('fma_params', JSON.stringify(queryParams));
  }

  exports.handleCurrentPageRedirect = handleCurrentPageRedirect;

}));


// autogenerated: handling the redirect for the current page
fmalib.handleCurrentPageRedirect();
